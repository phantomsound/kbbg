<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KBBG FM 88.1 — Home</title>
  <meta name="description" content="Stream music, culture, and community-focused talk from one of the nation’s oldest Black-owned public radio stations in Waterloo, Iowa." />
  <meta name="theme-color" content="#4B0082" />
  <meta property="og:title" content="KBBG FM 88.1 — Listen Live" />
  <meta property="og:description" content="Music, culture, and community-focused talk from Waterloo, Iowa." />
  <meta property="og:image" content="assets/og-kbbg-1200x630.jpg?v=20" />
  <link rel="stylesheet" href="styles.css?v=20" />
</head>
<body>
<header class="site-header">
  <a class="logo" href="./">KBBG 88.1</a>
  <nav class="nav">
    <a href="./" aria-current="page">Home</a>
    <a class="btn btn-gold" href="listen.html">Listen Live</a>
  </nav>
</header>

<main>
  <!-- Hero -->
  <section class="hero">
    <div class="hero-inner">
      <h1>Stream KBBG FM 88.1</h1>
      <p>Music, culture, and community-focused talk from one of the nation’s oldest Black-owned public radio stations.</p>
      <div class="cta-row">
        <a class="btn btn-gold btn-lg" href="listen.html">Open Full Player</a>
      </div>
    </div>
  </section>

  <!-- Minimal Live Player -->
  <section class="card center narrow" aria-label="KBBG 88.1 Live Player">
    <!-- Hidden native audio -->
    <audio id="homeAudio" preload="metadata">
      <source src="https://s5.radio.co/se50df870e/listen" type="audio/mpeg" />
      <source src="https://s5.radio.co/se50df870e/listen.m3u8" type="application/vnd.apple.mpegurl" />
    </audio>

    <div class="mini-player">
      <button id="homePlay" class="round-play" aria-label="Play/Pause">▶</button>
      <div class="eq" id="homeEq" aria-hidden="true">
        <span></span><span></span><span></span>
      </div>
      <div class="np-wrap">
        <div class="np-label">Now Playing</div>
        <div id="np-home" class="now-playing" aria-live="polite"></div>
      </div>
    </div>

    <!-- Last 5 Songs (collapsed by default) -->
    <details class="history-details">
      <summary class="history-summary">Last 5 Songs</summary>
      <ul id="history5" class="history-list"></ul>
    </details>
  </section>

  <!-- Apps -->
  <section class="card center narrow">
    <h2 class="section-title">Get the App</h2>
    <div class="store-row">
      <a class="store-badge" target="_blank" rel="noopener"
         href="https://play.google.com/store/apps/details?id=com.AppInstitute.kbbgfm88">Google Play</a>
      <a class="store-badge" target="_blank" rel="noopener"
         href="https://apps.apple.com/us/app/kbbg-fm-88-one-mobile/id6747726588">App Store</a>
    </div>
  </section>
</main>

<footer class="site-footer">
  <p>© <span id="y"></span> KBBG FM 88.1 · <a href="listen.html">Listen Live</a></p>
</footer>

<script>
  document.getElementById('y').textContent = new Date().getFullYear();

  // -------- Minimal Live Player (Home) --------
  const ha = document.getElementById('homeAudio');
  const playBtn = document.getElementById('homePlay');
  const eq = document.getElementById('homeEq');

  playBtn.addEventListener('click', async () => {
    try{
      if (ha.paused) {
        await ha.play();
        playBtn.textContent = '⏸';
        eq.classList.add('is-playing');
      } else {
        ha.pause();
        playBtn.textContent = '▶';
        eq.classList.remove('is-playing');
      }
    }catch(e){}
  });
  ha.addEventListener('ended', ()=>{ playBtn.textContent='▶'; eq.classList.remove('is-playing'); });

  // -------- Now Playing + History Utilities --------
  const CURRENT_URL = 'https://public.radio.co/api/v2/se50df870e/track/current';
  const HISTORY_URL = 'https://public.radio.co/api/v2/se50df870e/track/history';

  function isAd(item){
    const t = (item?.title || '').toLowerCase();
    const a = (item?.artist || '').toLowerCase();
    // Heuristics for ad/commercial/PSA/sweeper/station IDs
    return !!(
      item?.is_commercial === true ||
      /(^|\b)(ad|advert|advertisement|commercial|psa|sweeper|station id|promo)(\b|:)/i.test(item?.title || '') ||
      /(^|\b)(ad|advert|commercial|psa|sweeper|station id|promo)(\b|:)/i.test(item?.artist || '') ||
      (!t && !a) // sometimes ads have empty artist/title
    );
  }
  function formatNP(item){
    const title = item?.title || '';
    const artist = item?.artist || '';
    const art = item?.artwork || '';
    const ad = isAd(item);
    if (ad) {
      const label = `<strong class="ad-pill">AD</strong>`;
      return `${art ? `<img src="${art}" alt="" />` : ''}${label} ${title || 'Advertisement'}`;
    }
    return `${art ? `<img src="${art}" alt="" />` : ''}${artist ? `<strong>${artist}</strong> — ` : ''}${title}`;
  }
  function relTime(iso){
    const d = iso ? new Date(iso) : null;
    if(!d || isNaN(d)) return '';
    const diff = (Date.now() - d.getTime())/1000; // seconds
    if (diff < 60) return 'Just now';
    if (diff < 3600) return Math.floor(diff/60)+'m ago';
    if (diff < 86400) return Math.floor(diff/3600)+'h ago';
    return d.toLocaleString();
  }

  async function fetchNowPlaying(elId){
    try{
      const res = await fetch(CURRENT_URL, {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      const t = data?.data || {};
      const el = document.getElementById(elId);
      if(!el) return;
      el.innerHTML = formatNP(t);
    }catch(e){}
  }

  // Build a list of last N songs (exclude ads) and insert ad-break markers
  async function renderHistorySongs(elId, songLimit){
    const list = document.getElementById(elId);
    if(!list) return;
    try{
      const res = await fetch(HISTORY_URL, {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const json = await res.json();
      const raw = Array.isArray(json?.data) ? json.data : [];

      // Walk through history top → bottom adding:
      // - song items (non-ads) up to songLimit
      // - ad break markers, but DO NOT count ads towards the limit
      let out = [];
      let collectedSongs = 0;
      let adRun = 0;

      for (const item of raw) {
        const ad = isAd(item);
        if (ad) {
          adRun += 1;
          continue;
        }
        // we hit a song; if there was an ad run before it, add marker
        if (adRun > 0) {
          out.push({type:'adbreak', count: adRun});
          adRun = 0;
        }
        out.push({type:'song', item});
        collectedSongs += 1;
        if (collectedSongs >= songLimit) break;
      }
      // if history ends with an ad run (rare), append marker at the end
      if (adRun > 0 && collectedSongs>0) {
        out.push({type:'adbreak', count: adRun});
      }

      list.innerHTML = out.map(entry=>{
        if (entry.type === 'adbreak') {
          const n = entry.count;
          return `<li class="history-row adbreak"><div class="adline">Ad Break (${n} ad${n>1?'s':''})</div></li>`;
        } else {
          const it = entry.item;
          const art = it?.artwork || '';
          const title = it?.title || '';
          const artist = it?.artist || '';
          const when = relTime(it?.played_at || it?.start_time);
          return `<li class="history-row">
            ${art ? `<img src="${art}" alt="" />` : `<div class="art ph"></div>`}
            <div class="meta">
              <div class="t">${artist ? `<strong>${artist}</strong> — ` : ''}${title}</div>
              <div class="s">${when}</div>
            </div>
          </li>`;
        }
      }).join('');
    }catch(e){
      list.innerHTML = '<li class="history-empty">No recent tracks available.</li>';
    }
  }

  // Init
  fetchNowPlaying('np-home');
  renderHistorySongs('history5', 5);
  setInterval(()=>fetchNowPlaying('np-home'), 20000);
  setInterval(()=>renderHistorySongs('history5', 5), 60000);
</script>
</body>
</html>
